I"∂<h2 id="context">Context</h2>

<p>In this project, we are going to analyze data from an experiment about <em>honesty</em>. 
Oftentimes, we are asked to confirm our honest intentions by signing <strong>at the end</strong> of a document. 
For example, in tax returns or insurance policy forms, we are often asked to sign our names under a text that reads 
something like ‚ÄúI hereby certify that the above statements are true and correct to the best of my knowledge.‚Äù</p>

<p>However, when individuals sign <strong>after</strong> lying in the form, they may not feel the need to correct the falsehoods they 
have reported. In that context, it could be that signing at <strong>the beginning</strong> rather than at the end of the document 
would decrease dishonesty, as those who are filling the form would be aware of the ethical requirements <em>before</em> they 
provide the information in the form.</p>

<p>This intuition has led researchers to partner up with a motorcycle insurance company to run a randomized experiment. 
In this insurance company (as well as in many others), customers had to report the exact <em>odometer kilometrage</em>¬π in 
order for the company to adjust the insurance premiums. Note that motorcycles with lower kilometrage are less likely to 
have issues, and thus will result in a lower <em>insurance premium</em>¬≤. Therefore, customers have an incentive to lie, 
reporting a kilometrage lower than the real value, in order to save money.</p>

<p>In the experiment, two different forms were created: one where the signing was done at the end, and another where the 
signing was done at the beginning. The insurance company then randomized these forms (i.e., each customer received
 exactly one form, each with probability 50%) and sent back the data that customers had provided. Some noteworthy 
 details on the experiment are that:</p>

<ul>
  <li>All customers involved in the experiment already had a contract with the company and were simply renewing it. 
In the data that the company provided, they also report the odometer kilometrage for their previous contract.
Each policy, therefore, contains two contracts: the ‚Äúupdated‚Äù contract ‚Äîwhere the experiment was conducted‚Äî and 
the ‚Äúbaseline‚Äù contract, which was the previous contract customers had with the company.</li>
  <li>A single insurance policy can insure up to 4 distinct motorcycles.</li>
</ul>

<p>In this assignment, you will take the role of the researcher and work analyzing this data!</p>

<p><em>Glossary:</em></p>
<ol>
  <li><strong>odometer kilometrage:</strong> the total distance the motorcycle has traveled.</li>
  <li><strong>insurance premiums:</strong> the amount of money one pays for an insurance policy.</li>
</ol>

<hr />

<h2 id="the-data">The data</h2>

<p>The company provided you with a compressed <code class="language-plaintext highlighter-rouge">.tsv</code> file containing one row per policy. 
The <code class="language-plaintext highlighter-rouge">.tsv</code> has the following fields:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">condition</code>: either <code class="language-plaintext highlighter-rouge">Sign Top</code> or <code class="language-plaintext highlighter-rouge">Sign Bottom</code>, depending on which form was sent.</li>
  <li><code class="language-plaintext highlighter-rouge">id</code>: unique identifier for each insurance policy.</li>
  <li><code class="language-plaintext highlighter-rouge">motorcycle_count</code>: number of motorcycles covered by the insurance policy.</li>
  <li><code class="language-plaintext highlighter-rouge">baseline_motorcycle[1-4]</code>: odometer kilometrage <em>reported by the customer</em> in the <em>previous (baseline)</em> contract.</li>
  <li><code class="language-plaintext highlighter-rouge">update_motorcycle[1-4]</code>: odometer kilometrage <em>reported by the customer</em> in the <em>current (updated)</em> contract.</li>
</ul>

<p>Some comments:</p>

<ul>
  <li>Recall that a single policy can ensure up to 4 motorcycles, and thus, the suffixes [1-4] indicate that there are 4 
versions of these columns in the data (e.g., <code class="language-plaintext highlighter-rouge">baseline_motorcycle1</code>, <code class="language-plaintext highlighter-rouge">baseline_motorcycle2</code>, <code class="language-plaintext highlighter-rouge">baseline_motorcycle3</code>, 
<code class="language-plaintext highlighter-rouge">baseline_motorcycle4</code>).</li>
  <li>When a policy has fewer than 4 motorcycles, only the columns with the smaller numerals are filled (e.g., if a policy 
insures one motorcycle,  only <code class="language-plaintext highlighter-rouge">baseline_motorcycle1</code> and <code class="language-plaintext highlighter-rouge">update_motorcycle1</code> will be filled).</li>
  <li>Note that we only have access to the odometer kilometrage reported by the customers, 
which may be different from the real kilometrage of the motorcycles.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Imports you may need
</span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="n">tick</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Visualization parameters
</span>
<span class="n">mpl</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">'figure.dpi'</span><span class="p">]</span><span class="o">=</span> <span class="mi">100</span>
<span class="n">pd</span><span class="p">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">'display.max_rows'</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s">"darkgrid"</span><span class="p">)</span>

<span class="n">COLOR1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2980392156862745</span><span class="p">,</span> <span class="mf">0.4470588235294118</span><span class="p">,</span> <span class="mf">0.6901960784313725</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">COLOR2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8666666666666667</span><span class="p">,</span> <span class="mf">0.5176470588235295</span><span class="p">,</span> <span class="mf">0.3215686274509804</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">reformat_large_tick_values</span><span class="p">(</span><span class="n">tick_val</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="s">"""
    Turns large tick values (in the billions, millions and thousands) 
    such as 4500 into 4.5K and also appropriately turns 4000 into 4K 
    (no zero after the decimal).
    """</span>
    <span class="k">if</span> <span class="n">tick_val</span> <span class="o">&gt;=</span> <span class="mf">1e9</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tick_val</span><span class="o">/</span><span class="mi">1000000000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_tick_format</span> <span class="o">=</span> <span class="s">'{:}B'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tick_val</span> <span class="o">&gt;=</span> <span class="mf">1e6</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tick_val</span><span class="o">/</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_tick_format</span> <span class="o">=</span> <span class="s">'{:}M'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tick_val</span> <span class="o">&gt;=</span> <span class="mf">1e3</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tick_val</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_tick_format</span> <span class="o">=</span> <span class="s">'{:}K'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tick_val</span> <span class="o">&lt;</span> <span class="mf">1e3</span><span class="p">:</span>
        <span class="n">new_tick_format</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tick_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_tick_format</span> <span class="o">=</span> <span class="n">tick_val</span>

    <span class="c1"># make new_tick_format into a string value
</span>    <span class="n">new_tick_format</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_tick_format</span><span class="p">)</span>
    
    <span class="c1"># code below will keep 4.5M as is but change values such as 4.0M to 4M since that zero after the decimal isn't needed
</span>    <span class="n">index_of_decimal</span> <span class="o">=</span> <span class="n">new_tick_format</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"."</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">index_of_decimal</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">value_after_decimal</span> <span class="o">=</span> <span class="n">new_tick_format</span><span class="p">[</span><span class="n">index_of_decimal</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value_after_decimal</span> <span class="o">==</span> <span class="s">"0"</span><span class="p">:</span>
            <span class="c1"># remove the 0 after the decimal point since it's not needed
</span>            <span class="n">new_tick_format</span> <span class="o">=</span> <span class="n">new_tick_format</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">index_of_decimal</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_tick_format</span><span class="p">[</span><span class="n">index_of_decimal</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span>
            
    <span class="k">return</span> <span class="n">new_tick_format</span>

</code></pre></div></div>

<h3 id="task-1--4pts"><strong>Task 1</strong> ‚Äî 4pts</h3>

<p>Your first task is to load the dataset into memory using pandas. 
<strong>You should load the data directly from the compressed files.</strong></p>

<p>Here, the files at hand are rather small, and you could easily uncompress the files to disk and work with them as plain 
text. Why, then, are we asking you to load the files compressed? The reason is that, in your life as a data scientist, 
this will often not be the case. Then, working with compressed files is key so that you don‚Äôt receive email from your 
(often more responsible) colleagues demanding to know how you have managed to fill the entire cluster with your 
datasets. Another big advantage of compressing files is to simply read files faster. You will often find that reading
compressed data on the fly (uncompressing it as you go), is much faster than reading uncompressed data, since reading
and writing to disk may be your <a href="https://skipperkongen.dk/2012/02/28/uncompressed-versus-compressed-read/">bottleneck</a>.</p>

<hr />

<p><strong>Hint:</strong> <code class="language-plaintext highlighter-rouge">pandas</code> can open compressed files.</p>

<p><strong>Hint:</strong> In the real world (and in ADA-homework), your file often comes with some weird lines! 
This time you can safely ignore them (but in the real world you must try to understand why they are there!). 
Check the <code class="language-plaintext highlighter-rouge">error_bad_lines</code> or the <code class="language-plaintext highlighter-rouge">on_bad_lines</code> (depending on your pandas version) parameter on <code class="language-plaintext highlighter-rouge">read_csv</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s">'data/'</span>
<span class="n">DATASET</span> <span class="o">=</span> <span class="n">DATA_FOLDER</span><span class="o">+</span><span class="s">"data.tsv.gz"</span>

<span class="c1"># skip bad lines and warn which
</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATASET</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">,</span> <span class="n">on_bad_lines</span> <span class="o">=</span> <span class="s">'warn'</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'condition'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">condition</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'motorcycle_count'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">motorcycle_count</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span>

<span class="n">df</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b'Skipping line 2142: expected 11 fields, saw 27\n'
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>condition</th>
      <th>id</th>
      <th>baseline_motorcycle1</th>
      <th>update_motorcycle1</th>
      <th>baseline_motorcycle2</th>
      <th>update_motorcycle2</th>
      <th>baseline_motorcycle3</th>
      <th>update_motorcycle3</th>
      <th>baseline_motorcycle4</th>
      <th>update_motorcycle4</th>
      <th>motorcycle_count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Sign Top</td>
      <td>1</td>
      <td>896</td>
      <td>39198</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Sign Bottom</td>
      <td>2</td>
      <td>21396</td>
      <td>63511</td>
      <td>32659.0</td>
      <td>47605.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Sign Bottom</td>
      <td>3</td>
      <td>21340</td>
      <td>37460</td>
      <td>44998.0</td>
      <td>59002.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Sign Bottom</td>
      <td>4</td>
      <td>23912</td>
      <td>59136</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Sign Bottom</td>
      <td>5</td>
      <td>16862</td>
      <td>59292</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="task-2--12pts">Task 2 ‚Äî 12pts</h3>

<p>As a good data scientist, the first thing you do is to clean up the data and perform some small sanity checks.</p>

<p><strong>Hint:</strong> Here we are considering as outliers numbers that are not plausible in the context of motorcycle kilometrages.</p>

<hr />

<ol>
  <li>The motorcycle insurance company mentioned that each policy has a unique identifier, but that there may be duplicate 
rows (i.e., multiple rows with the same policy identifier). Check if there are duplicate policies and, if so, filter 
these rows from the data (always keeping the first).</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">before</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s">'first'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'We removed {} duplicate rows'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">before</span><span class="o">-</span><span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>We removed 8 duplicate rows
</code></pre></div></div>

<ol>
  <li>According to the company, all policies should have kept the number of motorcycles from the previous contract (i.e., 
the number of motorcycles recorded in baseline contracts should equal the number of motorcycles in updated contracts). 
Also, the number of odometer readings for each contract should be the same as the number stated in the 
<code class="language-plaintext highlighter-rouge">motorcycle_count</code> variable. Check the data to see if these two things hold. If not, filter the anomalous rows.</li>
</ol>

<font color="DarkCyan">
First, let's check that the numbers of motorcycles don't change. 

With boolean logic over columns, we'll check that, for $1\le k \le 4$, if either `baseline_motorcycle{k}` or `update_motorcycle{k}` is $\texttt{NaN}$, then both are.
</font>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">to_delete</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">bl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s">'baseline_motorcycle</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">'</span><span class="p">]</span>
    <span class="n">ud</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s">'update_motorcycle</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">'</span><span class="p">]</span>
    <span class="c1">#if at least one is NaN but not both 
</span>    <span class="n">new_to_delete</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">[(</span><span class="n">bl</span><span class="p">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="n">ud</span><span class="p">.</span><span class="n">isna</span><span class="p">())</span> <span class="o">&amp;</span> <span class="o">~</span> <span class="p">(</span><span class="n">bl</span><span class="p">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">ud</span><span class="p">.</span><span class="n">isna</span><span class="p">())]</span>
    <span class="n">to_delete</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_to_delete</span><span class="p">.</span><span class="n">to_numpy</span><span class="p">())</span>

<span class="k">print</span><span class="p">(</span><span class="s">'There are {} rows that should be removed, based on a fact that</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_delete</span><span class="p">))</span>\
      <span class="o">+</span><span class="s">'each baseline_motorcycle{k} and update_motorcycle{k} are either both Nan or both not.'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>There are 0 rows that should be removed, based on a fact that
each baseline_motorcycle{k} and update_motorcycle{k} are either both Nan or both not.
</code></pre></div></div>

<font color="DarkCyan">
So we can see that no row present this specific anomaly in this dataset.
    
Now let's check that `motorcycle_count` is the same as the actual number of motorcycles. Since we know that the number of motorcycles in update and baseline contracts is now consistent, we can simply use the baseline number.
We'll sum the number of baseline podometers that are not NaNs for each row, and compare it to `motorcycle_count`.
</font>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">actual_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="sa">f</span><span class="s">'baseline_motorcycle</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)]].</span><span class="n">notna</span><span class="p">().</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">to_drop</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">[(</span><span class="n">actual_count</span> <span class="o">!=</span> <span class="n">df</span><span class="p">.</span><span class="n">motorcycle_count</span><span class="p">)]</span>
<span class="k">print</span><span class="p">(</span><span class="n">to_drop</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">to_drop</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Int64Index([], dtype='int64')
</code></pre></div></div>

<ol>
  <li>Calculate the mean and the median value of each column related to kilometrages. Are the values obtained plausible? 
Visualize the distribution of the data and remove any extreme outliers.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">describe</span><span class="p">().</span><span class="n">loc</span><span class="p">[[</span><span class="s">'mean'</span><span class="p">,</span> <span class="s">'50%'</span><span class="p">]]</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>baseline_motorcycle1</th>
      <th>update_motorcycle1</th>
      <th>baseline_motorcycle2</th>
      <th>update_motorcycle2</th>
      <th>baseline_motorcycle3</th>
      <th>update_motorcycle3</th>
      <th>baseline_motorcycle4</th>
      <th>update_motorcycle4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>7.413448e+14</td>
      <td>7.413448e+14</td>
      <td>67324.756948</td>
      <td>92277.813595</td>
      <td>67657.320282</td>
      <td>92849.408771</td>
      <td>67827.97546</td>
      <td>93374.279141</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>5.633500e+04</td>
      <td>8.238800e+04</td>
      <td>56158.000000</td>
      <td>82066.000000</td>
      <td>58821.000000</td>
      <td>85645.000000</td>
      <td>68181.00000</td>
      <td>93387.500000</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span> <span class="o">=</span> <span class="s">'row'</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="s">'row'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">sbplt</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">sbplt</span><span class="p">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">sbplt</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
    
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="n">fig</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.45</span><span class="p">,</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="s">"Number of km"</span><span class="p">);</span>
<span class="n">fig</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span> <span class="s">"Number of policies"</span><span class="p">,</span> <span class="n">rotation</span> <span class="o">=</span> <span class="mi">90</span><span class="p">);</span>
<span class="n">plt</span><span class="p">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Distribution of km for each category'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="output_15_0.png" alt="png" /></p>

<font color="DarkCyan">
We first choose to exclude all the data with any kilometrage higher than 10M, because it is way to high for a coherent lifetime of a motorcycle.
</font>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Removing all rows were there is a odometer reading greater than 1e7
#DataFrame.ge(threshold) a DataFrame of the same shape of True/False depending
# if the value is greater or not than the threshold in input.
#.any(axis=1) returns whether any element over each row is True
#.ge(threshold).any(axis=1) gives the rows that have a least one value greater than the threshold
# using ~ (NOT) allows us to keep all the raws without any values superior to the fixed threshold
</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">9</span><span class="p">].</span><span class="n">ge</span><span class="p">(</span><span class="mf">1e7</span><span class="p">).</span><span class="nb">any</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">].</span><span class="n">plot</span><span class="p">.</span><span class="n">box</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> 
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Kilometrage'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Distribution of km for the different categories'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="output_18_0.png" alt="png" /></p>

<font color="DarkCyan">
We chose to keep odometer readings under 300.000km, as it is already a huge value of life time for a motorcycle.
</font>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">limit</span> <span class="o">=</span> <span class="mi">300000</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">9</span><span class="p">].</span><span class="n">ge</span><span class="p">(</span><span class="n">limit</span><span class="p">).</span><span class="nb">any</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">describe</span><span class="p">().</span><span class="n">loc</span><span class="p">[[</span><span class="s">'mean'</span><span class="p">,</span><span class="s">'50%'</span><span class="p">]]</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>baseline_motorcycle1</th>
      <th>update_motorcycle1</th>
      <th>baseline_motorcycle2</th>
      <th>update_motorcycle2</th>
      <th>baseline_motorcycle3</th>
      <th>update_motorcycle3</th>
      <th>baseline_motorcycle4</th>
      <th>update_motorcycle4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>65642.428049</td>
      <td>90544.518333</td>
      <td>65832.600465</td>
      <td>90787.770647</td>
      <td>66029.199521</td>
      <td>91170.264964</td>
      <td>67006.26087</td>
      <td>92589.928571</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>55943.000000</td>
      <td>81843.000000</td>
      <td>56001.500000</td>
      <td>81701.000000</td>
      <td>58117.000000</td>
      <td>85299.000000</td>
      <td>65550.00000</td>
      <td>92844.500000</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="s">'row'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">sbplt</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">sbplt</span><span class="p">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span> <span class="o">+</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>
    <span class="n">sbplt</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">sbplt</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">tick</span><span class="p">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">reformat_large_tick_values</span><span class="p">));</span>

<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="n">fig</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.45</span><span class="p">,</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="s">"Number of km"</span><span class="p">);</span>
<span class="n">fig</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span> <span class="s">"Number of policies"</span><span class="p">,</span> <span class="n">rotation</span> <span class="o">=</span> <span class="mi">90</span><span class="p">);</span>

<span class="n">plt</span><span class="p">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Distribution of data for the different categories after filtering'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="output_22_0.png" alt="png" /></p>

<ol>
  <li><strong>Discuss:</strong> In cases where you cannot think of appropriate ways to remove outliers, would you prefer summarizing 
numerical data with outliers with the mean or the median? Why?
‚Äî</li>
</ol>
<font color="DarkCyan">
We would rather choose the median because the mean is strongly influenced by outliers if they are large values (regarding the original distribution). For the median, having few outliers just shift the rank of the value obtained, which doesn't change too much the order of magnitude.


In cases where you cannot think of appropriate ways to remove outliers, it would be better to summarize the numerical data with the median as it would be a better representative of the shape and occurrence of the data than the mean which will be skewed by the outliers.</font>

<h3 id="task-3--12pts">Task 3 ‚Äî 12pts</h3>

<p>One of the challenges with the current data is that it is not clear how to handle policies with multiple motorcycles.</p>

<hr />

<ol>
  <li>Create three additional columns in the dataframe, <code class="language-plaintext highlighter-rouge">baseline_average</code>, <code class="language-plaintext highlighter-rouge">update_average</code>, and <code class="language-plaintext highlighter-rouge">diff_average</code>. These 
should contain, respectively, the average value for <code class="language-plaintext highlighter-rouge">baseline_motorcycle[1-4]</code> for all motorcycles insured; the average
 value for <code class="language-plaintext highlighter-rouge">update_motorcycle[1-4]</code>; and the difference between the average updated value and the average baseline 
 value.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#To select the columns on wich we apply the mean, we use condition on their name.
</span><span class="n">df</span><span class="p">[</span><span class="s">'baseline_average'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'baseline'</span><span class="p">)]].</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'update_average'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'update'</span><span class="p">)]].</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'diff_average'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">update_average</span> <span class="o">-</span> <span class="n">df</span><span class="p">.</span><span class="n">baseline_average</span> 
<span class="n">df</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>condition</th>
      <th>id</th>
      <th>baseline_motorcycle1</th>
      <th>update_motorcycle1</th>
      <th>baseline_motorcycle2</th>
      <th>update_motorcycle2</th>
      <th>baseline_motorcycle3</th>
      <th>update_motorcycle3</th>
      <th>baseline_motorcycle4</th>
      <th>update_motorcycle4</th>
      <th>motorcycle_count</th>
      <th>baseline_average</th>
      <th>update_average</th>
      <th>diff_average</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Sign Top</td>
      <td>1</td>
      <td>896</td>
      <td>39198</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
      <td>896.0</td>
      <td>39198.0</td>
      <td>38302.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Sign Bottom</td>
      <td>2</td>
      <td>21396</td>
      <td>63511</td>
      <td>32659.0</td>
      <td>47605.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2</td>
      <td>27027.5</td>
      <td>55558.0</td>
      <td>28530.5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Sign Bottom</td>
      <td>3</td>
      <td>21340</td>
      <td>37460</td>
      <td>44998.0</td>
      <td>59002.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2</td>
      <td>33169.0</td>
      <td>48231.0</td>
      <td>15062.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Sign Bottom</td>
      <td>4</td>
      <td>23912</td>
      <td>59136</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
      <td>23912.0</td>
      <td>59136.0</td>
      <td>35224.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Sign Bottom</td>
      <td>5</td>
      <td>16862</td>
      <td>59292</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
      <td>16862.0</td>
      <td>59292.0</td>
      <td>42430.0</td>
    </tr>
  </tbody>
</table>
</div>
:ET